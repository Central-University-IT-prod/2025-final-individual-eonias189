# Advertising service

## Запуск

```
docker-compose up -d
```

Для запуска проекта используется docker-compose.yml, который включает в себя несколько сервисов:

- **advertising-service**: основной сервис, который описан в спецификации

- **postgres**: база данных PostgreSQL для хранения данных о клиентах, рекламодателях, кампаниях и статистике

- **redis**: key-value хранилище для хранения даты

- **migrate**: сервис для запуска миграций базы данных PostgreSQL

- **minio**: объектное хранилище для хранения изображений рекламных объявлений

- **createbucket**: cервис для создания бакета в MinIO при старте

- **grafana**: cервис для визуализации статистики

После запуска сервис доступен на порту 8080

## Взаимодействие с системой

Для взаимодействия с системой можно использовать swagger editor и [спецификацию](https://gitlab.prodcontest.ru/2025-final-projects-back/eonias189/-/blob/master/solution/api/advertising-service.yml)

## Дополнения к [оригинальной спецификации](https://gitlab.prodcontest.ru/2025-final-indiv-tasks/prod-backend-individual-round-2025/-/blob/master/openapi.yaml)

### Коды ответов

Добавлены коды ответов 400 и 404, для некоторых эндпоинтов 403

### Добавление списка клиентов/рекламодателей

При добавлении списка клиентов/рекламодателей возвращаются только те значения, которые будут сохранены

### Схема рекламной кампании

Добавлено опциональное поле ad_image_url, которое не принимается при создании/обновлении, но может возвращаться при получении одной/списка рекламных кампаний и при получении рекламого объявления

### Идентификация рекламной кампании

Если в запросе, который требует и advertiserId, и campaignId, передать id кампании, которая не принадлежит рекламодателю с advertiserId, то возвращается код 404

### Получение списка рекламных кампаний

Рекламные кампании возвращаются отсортированными в обратном порядке создания, то есть сначала последние созданные

Параметры пагинации:

- size - количеств рекламных кампаний на одной странице (по умолчанию 50)
- page - номер страницы (начинается с 1, по умолчанию 1)

### Обновление рекламной кампании

Все поля кроме таргетинга обязательные, если их не передать, то возвращается код 400

При попытке изменения лимита показов/переходов или даты начала/конца уже начавшейся рекламной кампании возвращается код 403

### Фиксация перехода клиента по рекламному объявлению

При повторном переходе по рекламному объявлению возвращается код 204

При попытке фиксации перехода по рекламному объявлению, которое не было показано клиенту возвращается код 404

### Установка текущей даты

Если не передать current_date, то текущая дата увеличится на 1

## Дополнительная функциональность

### Настройка изображений в рекламных объявлениях

Добавлен эндпоинт PUT /advertisers/{advertiserId}/campaigns/{campaignId}/image для загрузки изображения рекламного объявления. (тег Campaigns в спецификации)

Тело запроса:

- изображение в формате png или jpeg

Тело ответа:

- ad_image_url - действующая ссылка на изображение или null, если изображение было удалено

![Пример загрузки изображения](./assets/load_campaign_ad_image.gif)

Для удаления изображения нужно передать пустое тело запроса (swagger editor не позволяет этого сделать):

```
curl --location --request PUT 'http://localhost:8080/advertisers/{advertiserId}/campaigns/{campaignId}/image' \
--header 'Content-type: image/png'
```

![Пример удаления изображения](./assets/delete_campaign_ad_image.gif)

### Визуализация статистики

Для визуализации статистики на порту 3000 поднимается grafana, логин и пароль дефолтные (admin, admin). В разделе Dashboards доступно 2 дашборда: "daily performance insights" и "top advertisers".

Для заполнения базы данных можно воспользоваться подготовленным скриптом:

```
source .env
go run advertising-service/cmd/seed/main.go
```

### Модерация текстов рекламных кампаний

Для модерации текстов рекламных объявлений добавлен эндпоинт POST /ai/moderate-ad-text (тег AI в спецификации). Для модерации используется LLM.

Тело запроса:

- ad_text - текст рекламного объявления

Тело ответа:

- ok - прошёл ли текст модерацию
- illegal_phrases - массив фраз, которые не прошли модерацию

### Интеграция с LLM для генерации рекламных текстов

Для генерации рекламных текстов добавлен эндпоинт POST /ai/generate-ad-text (тег AI в спецификации)

Тело запроса:

- ad_title - заголовок рекламного объявления

Тело ответа:

- ad_text - сгенерированный текст

![пример генерации текста](./assets/generate_ad_text.gif)

## Схема базы данных

![](./assets/database_scheme.jpeg)

## Алгоритма подбора рекламого объявления

Подбор рекламного объявления осуществляется [одним sql запросом](./advertising-service/internal/repo/postgres/ads.go). Его можно описать следующей схемой

![](./assets/algoritm.png)

## Используемые технологии

### 1. PostgreSQL

Идеально подходит для хранения структурированных данных, таких как информация о клиентах, рекламодателях, кампаниях, ML-скорах

**Преимущества**:

- Поддержка сложных запросов с объединениями и подзапросами
- Надежность и устойчивость к сбоям
- Легкость настройки и использования в локальной среде

При заявленном объёме данных разница между скоростью выполнения аналитических запросов в PostgreSQL и в колоночных базах незначительна

### 2. Redis

Используется для хранения текущей даты

**Преимущества**:

- Высокая скорость доступа к данным благодаря хранению в оперативной памяти
- Простота интеграции и использования

Скорость доступа к информации о текущей дате в данном случае важнее сохранности этой информации

### 3. MinIo

Используется для хранения изображений рекламных объявлений, которые могут быть большими по размеру и неудобными для хранения в реляционной базе данных

**Преимущества**:

- Высокая производительность и масштабируемость
- Простота интеграции с приложениями через S3-совместимый API
- Легкость настройки и использования в локальной среде

### 4. Grafana

Используется для визуализации статистики

**Преимущества**:

- Гибкость в создании графиков и дашбордов
- Поддержка множества источников данных (в том числе PostgreSQL)
- Удобный интерфейс для анализа данных в реальном времени

### 5. DeepSeek v3

Используется для генерации текста рекламных объявлений и их модерации

**Преимущества**:

- Высокая точность и качество генерации текста, в том числе на русском языке
- Поддержка модерации текста, в том числе на русском языке
- Простота интеграции через API

## Запуск тестов

### Юнит тесты

```
go test ./advertising-service/internal/...
```

Некоторые юнит тесты используют testcontainers для автоматического поднятия инфраструктуры, поэтому тестирование будет выполняться долго.

Может возникнуть ошибка `failed to open database: dial tcp REDACTED:<port>: connect: connection refused`. Она возникает, если postgres не успел подняться до запуска тестов. Это проблема testcontainers, решается перезапуском тестов

### E2E тесты

**Перед запуском** e2e тестов нужно очистить базу данных (удалить volume postgres_data) и запустить систему

**Запуск**

```
go test ./tests/e2e/... -v
```
